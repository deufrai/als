default:
    interruptible: true

stages:
  - setup
  - validate
  - build
  - deploy
  - changelog

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "push"
      when: never

Configure Build:
  extends: .default-job
  tags:
  - infra
  stage: setup
  script:
    - ci/setup_build.sh
  artifacts:
    reports:
      dotenv: .dotenv


Build PC/Linux:
  extends: .default-job
  tags:
  - amd64
  - linux
  stage: build
  timeout: 20m
  script:
    - ci/build_dist_amd64_linux.sh
  artifacts:
    expose_as: ALS for amd64 Linux
    paths:
      - als-$ALS_VERSION_STRING.run


Build RaspBerry/Linux:
  extends: .default-job
  tags:
  - arm64
  - linux
  stage: build
  timeout: 20m
  script:
    - ci/build_dist_arm64_linux.sh
  artifacts:
    expose_as: ALS for arm64 Linux
    paths:
      - als-$ALS_VERSION_STRING.tgz


Build Mac/Intel:
  extends: .default-job
  tags:
  - amd64
  - mac
  stage: build
  timeout: 20m
  script:
    - ci/build_dist_amd64_osx.sh
  artifacts:
    expose_as: ALS for Mac Intel
    paths:
      - als-$ALS_VERSION_STRING.dmg


Build PC/Windows:
  extends: .default-job
  tags:
  - amd64
  - win
  stage: build
  timeout: 35m
  script:
    - sh ci/build_dist_amd64_win.sh
  artifacts:
    expose_as: ALS for amd64 Windows
    paths:
      - als-$ALS_VERSION_STRING.exe


.default-job:
  before_script:
    - sh -c "env | sort"
